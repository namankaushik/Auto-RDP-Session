name: Auto RDP Session

on:
  schedule:
    # Run every 8 hours
    - cron: '0 */8 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  auto-rdp:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run RDP startup script
        shell: powershell
        run: |
          # Execute the startup script
          .\start-rdp.ps1
          
      - name: Display RDP Connection Details
        shell: powershell
        run: |
          # Display connection details from status file
          if (Test-Path "rdp-status.txt") {
            Write-Host "=== RDP SESSION CONNECTION DETAILS ==="
            Get-Content "rdp-status.txt" | ForEach-Object { Write-Host $_ }
            Write-Host "======================================"
          }
          
          # Also display from connection.rdp file if it exists
          if (Test-Path "connection.rdp") {
            Write-Host "\n=== RDP CONNECTION FILE CREATED ==="
            Write-Host "A connection.rdp file has been created for easy access"
            Write-Host "File contents:"
            Get-Content "connection.rdp" | ForEach-Object { Write-Host $_ }
            Write-Host "==================================="
          }
          
      - name: Create session logs directory
        shell: powershell
        run: |
          # Create logs directory if it doesn't exist
          if (!(Test-Path -Path "session-logs")) {
            New-Item -ItemType Directory -Path "session-logs"
          }
          
          # Generate timestamp for session
          $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
          
          # Create a comprehensive session log file
          $logFile = "session-logs\session_$timestamp.log"
          "RDP Session started at: $(Get-Date)" | Out-File -FilePath $logFile
          "Session ID: $env:GITHUB_RUN_ID" | Add-Content -Path $logFile
          "Workflow: $env:GITHUB_WORKFLOW" | Add-Content -Path $logFile
          "Runner OS: $env:RUNNER_OS" | Add-Content -Path $logFile
          "" | Add-Content -Path $logFile
          
          # Copy connection details to log file
          if (Test-Path "rdp-status.txt") {
            "=== RDP CONNECTION DETAILS ===" | Add-Content -Path $logFile
            Get-Content "rdp-status.txt" | Add-Content -Path $logFile
            "==============================" | Add-Content -Path $logFile
          }
          
          # List created files
          Write-Host "Created log files:"
          Get-ChildItem -Path "session-logs" | Format-Table
          
      - name: Upload RDP connection file
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rdp-connection-file-${{ github.run_number }}
          path: |
            connection.rdp
            rdp-status.txt
          retention-days: 7
          
      - name: Upload session artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rdp-session-logs-${{ github.run_number }}
          path: session-logs/
          retention-days: 30
          
      - name: Cleanup old artifacts (placeholder)
        shell: powershell
        run: |
          # Placeholder for cleanup logic
          Write-Host "Cleanup logic would go here"
          Write-Host "This could include:"
          Write-Host "- Removing old session files"
          Write-Host "- Backing up important data"
          Write-Host "- Sending notifications"
          Write-Host "- Managing storage quotas"
